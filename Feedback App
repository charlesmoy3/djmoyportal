<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DJ Moy ‚Äì Timestamp Feedback (V2.2)</title>

  <style>
  :root{
    --bg-dark:#0a0118;
    --bg-gradient-start:#1a0b2e;
    --bg-gradient-end:#0f0520;

    --card-glass: rgba(20, 15, 40, 0.78);
    --card-border: rgba(147, 112, 219, 0.34);

    --text:#ffffff;
    --muted: rgba(255,255,255,0.72);
    --muted2: rgba(255,255,255,0.52);

    --accent:#a855f7;
    --accent2:#06b6d4;
    --warn:#ef4444;

    --glow-purple: rgba(168, 85, 247, 0.42);
    --glow-blue: rgba(59, 130, 246, 0.30);

    --shadow: 0 20px 40px rgba(0,0,0,0.55);
    --radius: 18px;

    --panel: rgba(0,0,0,0.26);
    --panel2: rgba(0,0,0,0.38);

    --focus: rgba(6,182,212,0.35);
  }

  *{ box-sizing:border-box; }

  body{
    margin:0;
    font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, Arial, sans-serif;
    color: var(--text);
    min-height: 100%;
    position: relative;
    overflow-x: hidden;

    background-color:#000;
    background-image: url(https://raw.githubusercontent.com/charlesmoy3/djmoyportal/main/35862.png);
    background-repeat:no-repeat;
    background-size:cover;
    background-attachment:fixed;
    width:100%;
  }

  body::before{
    content:"";
    position:fixed;
    inset:0;
    background:
      radial-gradient(2px 2px at 20% 30%, white, transparent),
      radial-gradient(2px 2px at 60% 70%, white, transparent),
      radial-gradient(1px 1px at 50% 50%, white, transparent),
      radial-gradient(1px 1px at 80% 10%, white, transparent),
      radial-gradient(2px 2px at 90% 60%, white, transparent),
      radial-gradient(1px 1px at 33% 85%, white, transparent),
      radial-gradient(2px 2px at 75% 25%, white, transparent),
      radial-gradient(1px 1px at 10% 80%, white, transparent);
    background-size:
      200% 200%,
      300% 300%,
      250% 250%,
      280% 280%,
      220% 220%,
      260% 260%,
      240% 240%,
      290% 290%;
    background-position:50% 50%;
    animation: twinkle 3s ease-in-out infinite alternate;
    pointer-events:none;
    z-index:0;
    opacity:0.55;
  }

  @keyframes twinkle{
    0%,100%{ opacity:0.45; }
    50%{ opacity:0.8; }
  }

  body::after{
    content:"";
    position:fixed;
    top:-50%;
    left:-50%;
    width:200%;
    height:200%;
    background:
      radial-gradient(ellipse at 20% 30%, var(--glow-purple), transparent 55%),
      radial-gradient(ellipse at 80% 70%, var(--glow-blue), transparent 55%);
    pointer-events:none;
    z-index:0;
    animation: gradientShift 15s ease-in-out infinite;
  }

  @keyframes gradientShift{
    0%,100%{ transform: translate(0,0) rotate(0deg); }
    50%{ transform: translate(10%,10%) rotate(5deg); }
  }

  .wrap{ max-width:1040px; margin:0 auto; padding:18px; position:relative; z-index:1; }

  .card{
    position:relative;
    z-index:1;
    background: transparent;
    border:none;
    border-radius: var(--radius);
    padding:0;
    box-shadow:none;
    backdrop-filter:none;
  }

  .screen{ display:none; }
  .screen.active{ display:block; }

  /* ===== Landing Hero ===== */
  .hero{
    min-height: calc(100vh - 60px);
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:center;
    text-align:center;
    gap:14px;
    padding: 48px 14px;
  }

  .heroTitle{
    font-size: clamp(44px, 6vw, 78px);
    line-height: 1.05;
    margin: 0;
    letter-spacing: -0.02em;
  }

  .heroSub{
    color: var(--muted);
    font-size: 15px;
    line-height: 1.55;
    max-width: 68ch;
    margin: 0;
  }

  .heroBtns{
    margin-top: 12px;
    display:flex;
    gap:14px;
    flex-wrap:wrap;
    justify-content:center;
  }

  .heroBtns button{
    min-width: 260px;
    border-radius: 999px;
  }

  /* ===== Panel container (player screen) ===== */
  .panelCard{
    background: var(--card-glass);
    border:1px solid var(--card-border);
    border-radius: var(--radius);
    padding:16px;
    box-shadow: var(--shadow);
    backdrop-filter: blur(14px);
  }

  .row{ display:grid; gap:12px; grid-template-columns:1fr; }
  @media (min-width:900px){ .row{ grid-template-columns:1.2fr .8fr; } }

  .meter{
    border:1px solid rgba(255,255,255,0.10);
    border-radius:14px;
    padding:12px;
    background: var(--panel);
    display:grid;
    gap:8px;
    box-shadow: 0 10px 28px rgba(0,0,0,0.35);
  }

  .time{
    display:flex;
    justify-content:space-between;
    gap:12px;
    color:var(--muted);
    font-size:13px;
    font-variant-numeric: tabular-nums;
  }

  .small{ color:var(--muted); font-size:12px; }

  button{
    border:1px solid rgba(255,255,255,0.10);
    background: rgba(10, 8, 20, 0.62);
    color:var(--text);
    padding:14px 12px;
    border-radius:14px;
    font-size:15px;
    cursor:pointer;
    user-select:none;
    box-shadow: 0 10px 28px rgba(0,0,0,0.35);
    transition: box-shadow .15s ease, border-color .15s ease, transform .05s ease;
  }

  button:hover{
    border-color: var(--focus);
    box-shadow: 0 12px 36px rgba(0,0,0,0.45), 0 0 0 1px rgba(168,85,247,0.22);
  }

  button:active{ transform: translateY(1px); }

  button.secondary{ font-size:13px; padding:10px 12px; opacity:.98; }

  button.good{
    background: linear-gradient(180deg, rgba(6,182,212,0.18), rgba(0,0,0,0));
  }

  button.danger{
    background: linear-gradient(180deg, rgba(168,85,247,0.16), rgba(0,0,0,0));
  }

  .hr{ height:1px; background:rgba(255,255,255,0.08); margin:12px 0; }

  .hidden{ display:none !important; }

  audio{ width:100%; }

  .playerCard{
    border:1px solid rgba(255,255,255,0.10);
    border-radius:14px;
    padding:12px;
    background: var(--panel);
    display:grid;
    gap:10px;
    box-shadow: 0 10px 28px rgba(0,0,0,0.35);
  }

  .viz{
    width:100%;
    height:120px;
    border:1px solid rgba(255,255,255,0.08);
    border-radius:12px;
    background: rgba(0,0,0,0.33);
  }

  .reactions{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  @media (min-width:640px){ .reactions{ grid-template-columns:1fr 1fr 1fr 1fr; } }

  .log{
    max-height:520px;
    overflow:auto;
    border:1px solid rgba(255,255,255,0.10);
    border-radius:14px;
    padding:10px;
    background: var(--panel2);
    font-variant-numeric: tabular-nums;
    box-shadow: 0 10px 28px rgba(0,0,0,0.35);
  }

  .item{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:10px;
    padding:8px 6px;
    border-bottom: 1px dashed rgba(255,255,255,0.10);
  }
  .item:last-child{ border-bottom:none; }

  .tag{
    font-size:12px;
    padding:4px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,0.10);
    white-space:nowrap;
  }

  .tag.hate{ background: rgba(239,68,68,0.14); border-color: rgba(239,68,68,0.20); }
  .tag.dislike{ background: rgba(168,85,247,0.14); border-color: rgba(168,85,247,0.22); }
  .tag.like{ background: rgba(6,182,212,0.14); border-color: rgba(6,182,212,0.22); }
  .tag.love{ background: rgba(34,197,94,0.14); border-color: rgba(34,197,94,0.22); }
  .tag.note{ background: rgba(147,112,219,0.14); border-color: rgba(147,112,219,0.24); }

  .noteText{
    color: var(--text);
    font-size: 13px;
    margin-top:6px;
    line-height:1.25;
    overflow-wrap:anywhere;
    word-break:break-word;
    white-space:pre-wrap;
  }

  .metaLine{ color:var(--muted2); font-size:12px; margin-top:2px; }

  .topBar{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
  .topBarLeft{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

  .composer{
    border:1px solid rgba(255,255,255,0.10);
    border-radius:14px;
    padding:12px;
    background: var(--panel);
    display:grid;
    gap:10px;
    box-shadow: 0 10px 28px rgba(0,0,0,0.35);
  }

  textarea{
    width:100%;
    min-height:92px;
    resize:vertical;
    border:1px solid rgba(255,255,255,0.10);
    border-radius:12px;
    padding:12px;
    background: rgba(0,0,0,0.30);
    color: var(--text);
    outline:none;
    font-family: inherit;
    font-size:14px;
    line-height:1.3;
  }

  textarea:focus{
    border-color: rgba(6,182,212,0.35);
    box-shadow: 0 0 0 3px rgba(6,182,212,0.12);
  }

  /* Summary modal */
  .modalOverlay{
    position:fixed;
    inset:0;
    background: rgba(0,0,0,0.60);
    display:none;
    align-items:center;
    justify-content:center;
    padding:18px;
    z-index:9999;
  }

  .modalOverlay.active{ display:flex; }

  .modal{
    width:min(860px, 100%);
    border:1px solid var(--card-border);
    border-radius: var(--radius);
    background: rgba(20, 15, 40, 0.92);
    box-shadow: 0 24px 70px rgba(0,0,0,0.55);
    padding:14px;
    display:grid;
    gap:10px;
    backdrop-filter: blur(14px);
  }

  .modalHeader{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
  .modalTitle{ font-size:16px; margin:0; }

  .summaryBox{
    border:1px solid rgba(255,255,255,0.10);
    border-radius:14px;
    background: rgba(0,0,0,0.34);
    padding:12px;
    max-height:52vh;
    overflow:auto;
    white-space:pre-wrap;
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size:12.5px;
    line-height:1.35;
  }

  /* ===========================
     FOURTHWALL OVERRIDES
     =========================== */
  header,
  footer,
  [data-testid="site-header"],
  [data-testid="site-footer"]{
    display: none !important;
  }

  main,
  body{
    padding: 0 !important;
    margin: 0 !important;
  }

  .filePicker{
  position: absolute;
  left: -9999px;
  width: 1px;
  height: 1px;
  opacity: 0;
}

  </style>
</head>

<body>
  <div id="djmoyFeedbackApp">
    <div class="wrap">
      <div class="card">

        <!-- SCREEN 0: Landing -->
        <div id="screen0" class="screen active">
          <div class="hero">
            <h1 class="heroTitle">Timestamp Feedback</h1>
            <p class="heroSub">
              Get precise feedback from anyone ‚Äî even if they don‚Äôt know mixing terms.
              Reactions + notes are saved with exact timestamps.
            </p>

            <div class="heroBtns">
              <button id="startUpload" class="good">üìÅ Upload audio file</button>
              <button id="startSC" class="secondary">üîó Use SoundCloud link</button>
            </div>
          </div>
        </div>

        <!-- SCREEN 2: Player + Controls -->
        <div id="screen2" class="screen">
          <div class="panelCard">

            <div class="topBar">
              <div class="topBarLeft">
                <button id="backBtn" class="secondary">‚Üê Back</button>
              </div>

              <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button id="summaryBtn" class="secondary">View Summary</button>
                <button id="exportBtn" class="secondary">Export CSV</button>
                <button id="copyBtn" class="secondary">Copy Log</button>
                <button id="clearBtn" class="secondary danger">Clear Session</button>
              </div>
            </div>

            <!-- Hidden: used to open OS file picker when user clicks Upload -->
           <input id="file" type="file" accept="audio/*" class="filePicker" />


            <div class="hr"></div>

            <div class="row">
              <div>
                <div class="meter">
                  <div id="trackLine" class="small">Track: ‚Äî</div>
                  <div class="time">
                    <span>Now: <span id="now">0:00</span></span>
                    <span>Length: <span id="dur">‚Äî</span></span>
                  </div>
                </div>

                <div class="playerCard" style="margin-top:12px;">
                  <!-- Local audio -->
                  <div id="localPlayerWrap">
                    <canvas id="viz" class="viz"></canvas>
                    <audio id="player" controls></audio>
                  </div>

                  <!-- SoundCloud player -->
                  <div id="scPlayerWrap" class="hidden">
                    <iframe id="scFrame" allow="autoplay" style="width:100%; height:166px; border:0; border-radius:12px;"></iframe>
                  </div>
                </div>

                <div class="small" style="margin: 10px 0 8px;">Reactions</div>
                <div class="reactions">
                  <button id="hateBtn" class="danger">üò° Hate</button>
                  <button id="dislikeBtn" class="danger">üëé Dislike</button>
                  <button id="likeBtn" class="good">üëç Like</button>
                  <button id="loveBtn" class="good">‚ù§Ô∏è Love</button>
                </div>

                <div class="hr"></div>

                <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                  <button id="noteBtn" class="secondary" style="flex:1; min-width:160px;">üìù Note (lock timestamp)</button>
                  <div class="small" id="noteHint">Tap to lock the time, then type.</div>
                </div>

                <div id="composer" class="composer hidden" style="margin-top:10px;">
                  <div class="small">Note locked at: <b id="lockedAt">‚Äî</b></div>
                  <textarea id="noteText" placeholder="Type your note here..."></textarea>
                  <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    <button id="submitNoteBtn" class="good" style="flex:1; min-width:160px;">Submit Note</button>
                    <button id="cancelNoteBtn" class="secondary" style="flex:1; min-width:160px;">Cancel</button>
                  </div>
                </div>

                <div class="small" style="margin-top:10px;">
                  Keyboard shortcuts (optional): H = hate, D = dislike, L = like, V = love.
                </div>
              </div>

              <div>
                <div class="small" style="margin-bottom:8px;">Session log (auto-updates):</div>
                <div id="log" class="log"></div>
                <div class="small" style="margin-top:10px;">
                  Export/copy when you‚Äôre done.
                </div>
              </div>

            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Summary Modal -->
  <div id="modalOverlay" class="modalOverlay" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHeader">
        <h2 class="modalTitle">Session Summary</h2>
        <button id="closeModalBtn" class="secondary">Close</button>
      </div>
      <div class="summaryBox" id="summaryBox"></div>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button id="copySummaryBtn" class="secondary" style="flex:1; min-width:180px;">Copy Summary</button>
      </div>
      <div class="small">Summary is generated locally from this session‚Äôs log.</div>
    </div>
  </div>

  <!-- SoundCloud Widget API -->
  <script src="https://w.soundcloud.com/player/api.js"></script>

  <script>
  (() => {
    // Screens
    const screen0 = document.getElementById('screen0');
    const screen2 = document.getElementById('screen2');

    // Landing buttons (Screen 0)
    const startUpload = document.getElementById('startUpload');
    const startSC = document.getElementById('startSC');

    // Hidden local file input (Screen 2)
    const fileInput = document.getElementById('file');

    // Screen2 UI
    const backBtn = document.getElementById('backBtn');
    const trackLine = document.getElementById('trackLine');
    const nowEl = document.getElementById('now');
    const durEl = document.getElementById('dur');
    const logEl = document.getElementById('log');

    // Local player + viz
    const localWrap = document.getElementById('localPlayerWrap');
    const player = document.getElementById('player');
    const viz = document.getElementById('viz');
    const vizCtx = viz.getContext('2d');

    // SoundCloud player
    const scWrap = document.getElementById('scPlayerWrap');
    const scFrame = document.getElementById('scFrame');

    // Buttons
    const hateBtn = document.getElementById('hateBtn');
    const dislikeBtn = document.getElementById('dislikeBtn');
    const likeBtn = document.getElementById('likeBtn');
    const loveBtn = document.getElementById('loveBtn');

    const noteBtn = document.getElementById('noteBtn');
    const composer = document.getElementById('composer');
    const lockedAtEl = document.getElementById('lockedAt');
    const noteText = document.getElementById('noteText');
    const submitNoteBtn = document.getElementById('submitNoteBtn');
    const cancelNoteBtn = document.getElementById('cancelNoteBtn');

    const exportBtn = document.getElementById('exportBtn');
    const copyBtn = document.getElementById('copyBtn');
    const clearBtn = document.getElementById('clearBtn');

    // Summary modal
    const summaryBtn = document.getElementById('summaryBtn');
    const modalOverlay = document.getElementById('modalOverlay');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const copySummaryBtn = document.getElementById('copySummaryBtn');
    const summaryBox = document.getElementById('summaryBox');

    // State
    let mode = null; // 'local' | 'soundcloud'
    let session = null;
    let listenerName = null;

    // SoundCloud widget state
    let scWidget = null;
    let scReady = false;
    let scDurationMs = null;
    let scPollTimer = null;

    // Note lock state
    let pendingNoteTime = null;

    // Visualizer state
    let audioCtx = null;
    let sourceNode = null;
    let analyser = null;
    let dataArray = null;
    let vizRaf = null;

    function pad2(n){ return String(n).padStart(2,'0'); }
    function fmtTime(sec){
  sec = Math.max(0, Number(sec) || 0);
  const m = Math.floor(sec / 60);
  const s = Math.floor(sec % 60);
  return `${m}:${pad2(s)}`;
}

// ‚úÖ SoundCloud title via oEmbed (reliable)
async function resolveSoundCloudTitle(url){
  try{
    const oembed = `https://soundcloud.com/oembed?format=json&url=${encodeURIComponent(url)}`;
    const res = await fetch(oembed);
    if (!res.ok) return null;
    const data = await res.json();
    return data?.title || null;
  } catch(e){
    return null;
  }
}


    

    function newSession(){
      session = {
        createdAt: Date.now(),
        listener: (listenerName || '').trim() || null,
        mode,
        trackLabel: null,
        marks: []
      };
      updateHeader();
      renderLog();
    }

    function updateHeader(){
      trackLine.textContent = `Track: ${session?.trackLabel || '‚Äî'}`;
    }

    function goto(id){
      [screen0, screen2].forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    function askNameOptional(){
      const current = (listenerName || '').trim();
      const name = window.prompt('Listener name (optional):', current);
      if (name !== null) listenerName = name.trim();
    }

    function confirmLoseSessionIfNeeded(){
      if (!session || !session.marks.length) return true;
      return confirm('This will clear the current session log. Continue?');
    }

    function isNearBottom(el, thresholdPx = 40){
      return (el.scrollHeight - el.scrollTop - el.clientHeight) < thresholdPx;
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    function renderLog(){
      if (!session || !session.marks.length){
        logEl.innerHTML = `<div class="small">No marks yet. Tap reactions or add a note.</div>`;
        return;
      }

      const shouldStick = isNearBottom(logEl);
      const sorted = session.marks.slice().sort((a,b) => a.t - b.t);

      logEl.innerHTML = sorted.map((m, idx) => {
        const time = fmtTime(m.t);

        if (m.type === 'note'){
          const safe = escapeHtml(m.text || '');
          return `
            <div class="item">
              <div>
                <span class="tag note">üìù note</span>
                <span class="metaLine"> @ ${time}</span>
                <div class="noteText">${safe}</div>
              </div>
              <button class="secondary" data-del="${idx}">Delete</button>
            </div>
          `;
        }

        const map = {
          hate:  { tag:'hate',  label:'üò° hate' },
          dislike:{ tag:'dislike',label:'üëé dislike' },
          like:  { tag:'like',  label:'üëç like' },
          love:  { tag:'love',  label:'‚ù§Ô∏è love' },
        };

        const info = map[m.type];
        return `
          <div class="item">
            <div>
              <span class="tag ${info.tag}">${info.label}</span>
              <span class="metaLine"> @ ${time}</span>
            </div>
            <button class="secondary" data-del="${idx}">Delete</button>
          </div>
        `;
      }).join('');

      logEl.querySelectorAll('button[data-del]').forEach(btn => {
        btn.addEventListener('click', () => {
          const idx = Number(btn.getAttribute('data-del'));
          const sorted2 = session.marks.slice().sort((a,b) => a.t - b.t);
          const target = sorted2[idx];
          const realIdx = session.marks.findIndex(x => x.t === target.t && x.type === target.type && x.at === target.at);
          if (realIdx >= 0) session.marks.splice(realIdx, 1);
          renderLog();
        });
      });

      if (shouldStick) logEl.scrollTop = logEl.scrollHeight;
    }

    async function getCurrentTimeSec(){
      if (!mode) return 0;

      if (mode === 'local'){
        return player.currentTime || 0;
      }

      if (mode === 'soundcloud'){
        if (!scWidget || !scReady) throw new Error('SoundCloud not ready');
        return new Promise((resolve) => {
          scWidget.getPosition((ms) => resolve((ms || 0) / 1000));
        });
      }

      return 0;
    }

    function pushMark(type, t, text=null){
      if (!session) return;
      session.marks.push({ type, t: Number((t || 0).toFixed(2)), text, at: Date.now() });
      renderLog();
    }

    async function mark(type){
      if (!session) return;
      try{
        const t = await getCurrentTimeSec();
        pushMark(type, t);
      }catch(e){
        alert('Load a track first.');
      }
    }

    async function lockNoteTimestamp(){
      if (!session) return alert('Load a track first.');
      try{
        const t = await getCurrentTimeSec();
        pendingNoteTime = t;
        lockedAtEl.textContent = fmtTime(t);
        composer.classList.remove('hidden');
        noteText.value = '';
        noteText.focus();
      }catch(e){
        alert('Load a track first.');
      }
    }

    function cancelNote(){
      pendingNoteTime = null;
      composer.classList.add('hidden');
      noteText.value = '';
    }

    function submitNote(){
      if (pendingNoteTime == null) return;
      const txt = (noteText.value || '').trim();
      if (!txt) return alert('Type a note first.');
      pushMark('note', pendingNoteTime, txt);
      cancelNote();
    }

    function clearViz(){
      const W = viz.width, H = viz.height;
      vizCtx.clearRect(0,0,W,H);
      vizCtx.globalAlpha = 0.25;
      vizCtx.fillStyle = "#ffffff";
      vizCtx.fillRect(0, H-2, W, 1);
      vizCtx.globalAlpha = 1;
    }

    function resizeViz(){
      const rect = viz.getBoundingClientRect();
      viz.width = Math.max(320, Math.floor(rect.width * devicePixelRatio));
      viz.height = Math.floor(120 * devicePixelRatio);
      clearViz();
    }
    window.addEventListener('resize', () => { if (mode === 'local') resizeViz(); });

    function stopVisualizer(){
      if (vizRaf) cancelAnimationFrame(vizRaf);
      vizRaf = null;
      analyser = null;
      dataArray = null;
      clearViz();
    }

    async function ensureAudioContext(){
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (!sourceNode){
        sourceNode = audioCtx.createMediaElementSource(player);
      }
      if (audioCtx.state === 'suspended'){
        try { await audioCtx.resume(); } catch(e) {}
      }
    }

    function startVisualizer(){
      stopVisualizer();
      resizeViz();

      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 256;
      dataArray = new Uint8Array(analyser.frequencyBinCount);

      try { sourceNode.disconnect(); } catch(e) {}
      try { analyser.disconnect(); } catch(e) {}
      sourceNode.connect(analyser);
      analyser.connect(audioCtx.destination);

      const W = viz.width, H = viz.height;

      function draw(){
        if (!analyser || !dataArray) return;
        analyser.getByteFrequencyData(dataArray);

        vizCtx.clearRect(0,0,W,H);

        const barCount = dataArray.length;
        const barW = W / barCount;

        const grad = vizCtx.createLinearGradient(0, 0, W, 0);
        grad.addColorStop(0.00, "#7c3aed");
        grad.addColorStop(0.35, "#22d3ee");
        grad.addColorStop(0.70, "#a3ff12");
        grad.addColorStop(1.00, "#ff4fd8");

        vizCtx.fillStyle = grad;
        vizCtx.globalAlpha = 0.95;
        vizCtx.shadowColor = "rgba(34,211,238,0.45)";
        vizCtx.shadowBlur = Math.max(6, W / 220);

        for (let i=0;i<barCount;i++){
          const v = dataArray[i] / 255;
          const bh = v * (H * 0.85);
          const x = i * barW;
          const y = H - bh;
          vizCtx.fillRect(x + barW*0.15, y, barW*0.7, bh);
        }

        vizCtx.shadowBlur = 0;
        vizCtx.shadowColor = "transparent";

        vizCtx.globalAlpha = 0.18;
        vizCtx.fillStyle = "#ffffff";
        vizCtx.fillRect(0, H-2, W, 1);
        vizCtx.globalAlpha = 1;

        vizRaf = requestAnimationFrame(draw);
      }

      vizRaf = requestAnimationFrame(draw);
    }

    player.addEventListener('play', async () => {
      if (mode !== 'local') return;
      await ensureAudioContext();
      startVisualizer();
    });

    function resetLocalPlayer(){
      if (scPollTimer) clearInterval(scPollTimer);
      scPollTimer = null;
      scReady = false;
      scWidget = null;
      scFrame.src = '';

      scWrap.classList.add('hidden');
      localWrap.classList.remove('hidden');

      try { player.pause(); } catch(e) {}
      player.removeAttribute('src');
      player.load();

      durEl.textContent = '‚Äî';
      nowEl.textContent = '0:00';
    }

async function loadSoundCloudUrl(url){
  stopVisualizer();
  scWrap.classList.remove('hidden');
  localWrap.classList.add('hidden');

  const encoded = encodeURIComponent(url);
  scFrame.src = `https://w.soundcloud.com/player/?url=${encoded}&auto_play=false&hide_related=false&show_comments=true&show_user=true&show_reposts=false&visual=true`;

  scWidget = SC.Widget(scFrame);
  scReady = false;
  scDurationMs = null;

  await new Promise((resolve) => {
    scWidget.bind(SC.Widget.Events.READY, () => {
      scReady = true;

      scWidget.getDuration((ms) => {
        scDurationMs = ms || null;
        if (scDurationMs) durEl.textContent = fmtTime(scDurationMs / 1000);
      });

      // ‚úÖ Try SoundCloud metadata (sometimes delayed)
      scWidget.getCurrentSound((sound) => {
        const title = sound?.title || null;
        const artist = sound?.user?.username || sound?.user?.full_name || null;

        if (session && title) {
          session.trackLabel = artist ? `${title} ‚Äî ${artist}` : title;
          updateHeader();
        }
      });

      // ‚úÖ Always resolve so we don't hang
      resolve();
    });
  });

  if (scPollTimer) clearInterval(scPollTimer);
  scPollTimer = setInterval(() => {
    if (!scWidget || !scReady) return;
    scWidget.getPosition((ms) => nowEl.textContent = fmtTime((ms || 0) / 1000));
  }, 250);

  // Fallback label only if nothing else set it
  if (session && !session.trackLabel) {
    session.trackLabel = url;
    updateHeader();
  }
}


    function hardResetSession(){
      resetLocalPlayer();
      stopVisualizer();
      pendingNoteTime = null;
      cancelNote();
      fileInput.value = '';
      session = null;
      mode = null;
      logEl.innerHTML = `<div class="small">No session loaded.</div>`;
      trackLine.textContent = `Track: ‚Äî`;
    }

    // ===== Landing actions (2-screen flow) =====
   startUpload.addEventListener('click', () => {
  if (!confirmLoseSessionIfNeeded()) return;

  mode = 'local';
  goto('screen2');

  // Create/clear session now (listener can be set after file choose)
  newSession();

  // MUST happen immediately from the user click (no prompt before it)
  fileInput.value = '';
  fileInput.click();
});


    startSC.addEventListener('click', async () => {
      if (!confirmLoseSessionIfNeeded()) return;
      askNameOptional();

      const raw = window.prompt('Paste the SoundCloud track link:', '');
if (!raw) return;

const url = raw.trim();

mode = 'soundcloud';
goto('screen2');
newSession();

// ‚úÖ set a clean track name immediately (oEmbed is reliable)
const title = await resolveSoundCloudTitle(url);
if (session) {
  session.trackLabel = title || url;
  updateHeader();
}

try {
  await loadSoundCloudUrl(url);
} catch(e){
  alert('Could not load that SoundCloud link.');
  console.error(e);
}

    });

    // ===== Load local file =====
    fileInput.addEventListener('change', () => {
      resetLocalPlayer();

      const f = fileInput.files && fileInput.files[0];
      if (!f) return;
        // Ask for name only after the file is chosen (keeps picker unblocked)
  if (!listenerName) {
    askNameOptional();
    if (session) session.listener = (listenerName || '').trim() || null;
  }


      mode = 'local';
      if (!session) newSession();

      session.trackLabel = f.name || 'Local file';
      updateHeader();

      const url = URL.createObjectURL(f);
      player.src = url;
      player.load();

      player.onloadedmetadata = () => {
        durEl.textContent = fmtTime(player.duration || 0);
      };

      player.ontimeupdate = () => {
        nowEl.textContent = fmtTime(player.currentTime || 0);
      };
    });

    // Back (always to landing)
    backBtn.addEventListener('click', () => {
      hardResetSession();
      goto('screen0');
    });

    // Reactions
    hateBtn.addEventListener('click', () => mark('hate'));
    dislikeBtn.addEventListener('click', () => mark('dislike'));
    likeBtn.addEventListener('click', () => mark('like'));
    loveBtn.addEventListener('click', () => mark('love'));

    // Notes
    noteBtn.addEventListener('click', lockNoteTimestamp);
    submitNoteBtn.addEventListener('click', submitNote);
    cancelNoteBtn.addEventListener('click', cancelNote);

    // Keyboard shortcuts
    window.addEventListener('keydown', (e) => {
      if (!session) return;
      if (composer && !composer.classList.contains('hidden')) return;

      const k = (e.key || '').toLowerCase();
      if (k === 'h') mark('hate');
      if (k === 'd') mark('dislike');
      if (k === 'l') mark('like');
      if (k === 'v') mark('love');
    });

    // Export CSV
    exportBtn.addEventListener('click', () => {
      if (!session) return alert('No session loaded.');

      const rows = [];
      rows.push(['listener','mode','track','type','timestamp_sec','timestamp_mmss','note','created_at'].join(','));

      const sorted = session.marks.slice().sort((a,b) => a.t - b.t);
      for (const m of sorted){
        rows.push([
          (session.listener || ''),
          (session.mode || ''),
          (session.trackLabel || ''),
          (m.type || ''),
          (m.t ?? ''),
          fmtTime(m.t || 0),
          (m.text ? `"${String(m.text).replaceAll('"','""')}"` : ''),
          new Date(m.at).toISOString()
        ].join(','));
      }

      const blob = new Blob([rows.join('\n')], { type: 'text/csv;charset=utf-8' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `timestamp-feedback_${Date.now()}.csv`;
      a.click();
    });

    // Copy Log
    copyBtn.addEventListener('click', async () => {
      if (!session) return alert('No session loaded.');

      const sorted = session.marks.slice().sort((a,b) => a.t - b.t);
      const text = sorted.map(m => {
        if (m.type === 'note') return `[${fmtTime(m.t)}] NOTE: ${m.text}`;
        return `[${fmtTime(m.t)}] ${m.type.toUpperCase()}`;
      }).join('\n');

      try { await navigator.clipboard.writeText(text); alert('Log copied.'); }
      catch(e) { prompt('Copy log:', text); }
    });

    // Clear
    clearBtn.addEventListener('click', () => {
      if (!session) return;
      if (!confirm('Clear this session?')) return;
      session.marks = [];
      renderLog();
    });

    // ===== Summary modal =====
    function buildSummaryText(){
      if (!session) return 'No session loaded.';
      const sorted = session.marks.slice().sort((a,b) => a.t - b.t);

      const counts = { hate:0, dislike:0, like:0, love:0, note:0 };
      for (const m of sorted){
        if (counts[m.type] != null) counts[m.type]++;
      }

      const header = [
        `Listener: ${session.listener || '‚Äî'}`,
        `Mode: ${session.mode || '‚Äî'}`,
        `Track: ${session.trackLabel || '‚Äî'}`,
        `Marks: üò° ${counts.hate} | üëé ${counts.dislike} | üëç ${counts.like} | ‚ù§Ô∏è ${counts.love} | üìù ${counts.note}`,
        `---`
      ].join('\n');

      const body = sorted.map(m => {
        if (m.type === 'note') return `[${fmtTime(m.t)}] NOTE: ${m.text}`;
        return `[${fmtTime(m.t)}] ${m.type.toUpperCase()}`;
      }).join('\n');

      return `${header}\n${body}`;
    }

    function openSummary(){
      summaryBox.textContent = buildSummaryText();
      modalOverlay.classList.add('active');
    }
    function closeSummary(){
      modalOverlay.classList.remove('active');
    }

    summaryBtn.addEventListener('click', openSummary);
    closeModalBtn.addEventListener('click', closeSummary);
    modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) closeSummary(); });

    copySummaryBtn.addEventListener('click', async () => {
      const text = buildSummaryText();
      try { await navigator.clipboard.writeText(text); alert('Summary copied.'); }
      catch(e) { prompt('Copy summary:', text); }
    });

    // Initial log state
    logEl.innerHTML = `<div class="small">No session loaded.</div>`;
  })();
  </script>
</body>
</html>
